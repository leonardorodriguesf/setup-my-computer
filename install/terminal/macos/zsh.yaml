- name: "Install oh-my-zsh"
  when: ansible_os_family == "Darwin"
  block:
    - name: "Check if oh-my-zsh is installed"
      command: "ls -d ~/.oh-my-zsh"
      register: oh_my_zsh_installed
      failed_when: false
    - name: "Install oh-my-zsh"
      when: oh_my_zsh_installed.rc != 0
      shell: sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    - name: "Check if auto-suggestions plugin is installed"
      command: "ls -d ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
      register: zsh_autosuggestions_installed
      failed_when: false
    - name: "Install auto-suggestions plugin"
      when: zsh_autosuggestions_installed.rc != 0
      shell: "git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions"
    - name: "Add auto-suggestions plugin"
      lineinfile:
        path: "{{ lookup('env', 'HOME') }}/.zshrc"
        state: present
        regexp: "^plugins=\\((?!.*zsh-autosuggestions).*\\)"
        line: "plugins=(\1 zsh-autosuggestions)"
